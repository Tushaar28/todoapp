<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">


  <title>To Do List</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
    
    #add {
      visibility: hidden;
    }
    #newTask{
      margin-top: 30px;
      margin-bottom: 30px;
      margin-right: 30px;
    }
  </style>
  <script>
    function func(){
      var elem = document.getElementById("add")
      elem.style.visibility = "visible"
      window.location.href = "#addTask"
    }
  </script>
</head>

<body>
  <!--                              ADD TASK BUTTON                                     -->
  <div class="text-right">
    <button type="submit" class="btn btn-info" id="newTask" onclick=func()>Add Task</button>
  </div>
  
  <div class="container">
    <div class="alert alert-success" role="alert" style="text-align: center">
      YOUR TASKS
    </div>

    <!--                                          SORT BY                                    -->
    <div class = "text-right">
      <div class="dropdown show">
        <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Sort By
        </a>
      
        <div class="dropdown-menu pull-right" aria-labelledby="dropdownMenuLink">
          <a class="dropdown-item nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Due Date
          </a><br>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="#">Ascending</a><br>
            <a class="dropdown-item" href="#">Descending</a>
          </div>
          <a class="dropdown-item" href="#">Priority</a><br>
          <a class="dropdown-item" href="#">Status</a><br>
        </div>
      </div>
    </div>

    <!--                                           TABLE                                           -->
    <div class="container">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Title</th>
            <th scope="col">Due Date</th>
            <th scope="col">Priority</th>
            <th scope="col">Delete</th>
            <th scope="col">View Notes</th>
          </tr>
        </thead>
        <tbody id="setRow" />
      </table>
    </div>
    <div id = "add">
    <div class="alert alert-info" role="alert" style="text-align: center">
      CREATE A NEW TASK
    </div>

    <!--                               ADD TASK FORM                               -->
    <div class="container">
      <form action="" class="addTodo" id = "addTask" method="POST">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" class="form-control" id="title" placeholder="Enter title" required><br>
          <label for="description">Description</label>
          <input type="text" class="form-control" id="description" placeholder="Enter description"><br>
          <label for="date">Due Date</label>
          <input type="date" class="form-control" id="due_date"><br>
          <label for="priority">Priority :&nbsp;&nbsp;</label>
          <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary active">
              <input type="radio" name="options" id="priority" value="1"> Low
            </label>
            <label class="btn btn-secondary">
              <input type="radio" name="options" id="priority" value="2" checked> Medium
            </label>
            <label class="btn btn-secondary">
              <input type="radio" name="options" id="priority" value="3"> High
            </label>
          </div>
          <br /><br />
        </div>
        <button type="submit" class="btn btn-primary">Add</button>
        <button type="reset" class="btn btn-danger">Reset</button>
      </form>
    </div>
  </div>
  </div>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    const apiUrl = 'https://quiet-eyrie-33557.herokuapp.com'
    const proxyurl = "https://peaceful-temple-16111.herokuapp.com";
    let serialNumber = 1;
    const sendCred = async () => {
      return await new Promise(async (resolve, reject) => {
        try {
          let data = {
            title: $('#title').val(),
            description: $('#description').val(),
            dueDate: $('#due_date').val(),
            priority: $('#priority').val(),
            status: $('#status').val(),
          }
          let response = await fetch(`${proxyurl}/${apiUrl}/addTask`, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            },
          })
          response = await response.json();
          console.log(response);
          resolve(response);
        } catch (err) {
          alert(err);
          reject(err);
        }
      })
    }

    const getData = async () => {
      fetch(`${proxyurl}/${apiUrl}/getInfo`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(res => {
          console.log(res)
          return res.json();
        })
        .then(data => {
          data = data.todo
          console.log(data)
          data.map((todo, i) => {
              if (todo.priority == 1) setPriority = 'Low'
              if (todo.priority == 2) setPriority = 'Medium'
              if (todo.priority == 3) setPriority = 'High'

              $('#setRow').append($(`<tr id="setData${serialNumber}"><th scope="row">`).text(serialNumber))
              $(`#setData${serialNumber}`).append($('<td>').text(todo.title))
              // $(`#setData${serialNumber}`).append($('<p>').text(`Description : ${todo.description}`))
              $(`#setData${serialNumber}`).append($('<td>').text(todo.due_date))
              $(`#setData${serialNumber}`).append($('<td>').text(setPriority))
              $(`#setData${serialNumber}`).append($(`
              <td><button type="button" class="btn btn-danger" onclick='deleteTodo(${i})'>Delete</button></td>
              `))
              $(`#setData${serialNumber}`).append($(`
                <td>
                  <div class='btn-group' role='group' aria-label='Basic example'>
                    <button class='btn btn-primary' type='button' data-toggle='collapse'
                      data-target='#collapseNotes${serialNumber}'
                      aria-expanded='false' aria-controls='collapseExample'>
                      View
                    </button>
                    <button class='btn btn-success' type='button' data-toggle='collapse'
                      data-target='#collapseAddNote${serialNumber}'
                      aria-expanded='false' aria-controls='collapseExample'>
                      Add
                    </button>
                  </div>

                  <div class='collapse' id='collapseNotes${serialNumber}'>
                    <ul id='viewNotes${serialNumber}' class='list-group list-group-flush'></ul>
                  </div>

                  <div class='collapse' id='collapseAddNote${serialNumber}'>
                    <br />
                    <form action='' class='addNote'>
                      <div class='form-group'>
                        <input type='text' class='form-control' id='inputNote${serialNumber}' placeholder='Add Note...'>
                      </div>
                      <button type='submit' onclick='addNotes(${i})'
                        class='btn btn-outline-secondary'>Add</button>
                    </form>
                  </div>
                </td>
              `))
              todo.notes.map((notes) => {
                $(`#viewNotes${serialNumber}`).append($('<li class="list-group-item">').text(notes.notes))
              })
              serialNumber++;
            }

          )
        })
        .catch(error => {
          console.log(error)
        })

    }

    const addNotes = async (serial) => {
      serial += 1
      console.log($(`#inputNote${serial}`).val())
      return await new Promise(async (resolve, reject) => {
        try {
          let data = {
            notes: $(`#inputNote${serial}`).val()
          }
          console.log(data.notes + ' : ' + serial)
          if (data.notes == '') throw err = "Note should not be empty"
          let response = await fetch(`${proxyurl}/${apiUrl}/addNotes/${serial}`, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            },
          })

          response = await response.json();
          resolve(response);
        } catch (err) {
          console.log(err)
          reject(err);
        }
      })
    }

    const deleteTodo = async (serial) => {
      serial += 1
      return await new Promise(async (resolve, reject) => {
        try {
          let response = await fetch(`${proxyurl}/${apiUrl}/deleteTodo/${serial}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
          })
          response = await response.json();
          alert(response.alert)
          resolve(response);
        } catch (err) {
          alert(err)
          reject(err);
        }
      })
    }

    getData();


    $('.addTodo').submit(function (e) {
      sendCred();
    })
  </script>

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
  </script>
</body>

</html>